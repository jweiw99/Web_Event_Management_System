<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="keywords" content="">

    <title>Profile</title>

    <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />

    <!-- Custom fonts for this website-->
    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet">

    <!-- Plugin styles for this website-->
    <link href="vendor/wizard/css/paper-bootstrap-wizard.css" rel="stylesheet" />

    <!-- Custom styles for this website-->
    <link href="css/utar2share.css" rel="stylesheet">

</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light" id="mainNav">
        <div class="container">
            <img src="images/logo.png" height="45" width="70" alt="UTAR 2SHARE"></a>
            <span class="navbar-brand js-scroll-trigger">UTAR 2SHARE</span>
            <button class="navbar-toggler navbar-toggler-right btn btn-link rounded-circle" type="button"
                data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive"
                aria-expanded="false" aria-label="Toggle navigation">
                <i class="fas fa-bars"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link js-scroll-trigger" href="post.html">Posts</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link js-scroll-trigger" href="event.html">Events</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link js-scroll-trigger" href="forum.html">Forum</a>
                    </li>
                </ul>
            </div>
            <div class="collapse navbar-collapse" id="navbarResponsive">

                <!-- Topbar Navbar -->
                <ul class="navbar-nav ml-auto">

                    <div class="topbar-divider d-none d-sm-block"></div>

                    <!-- Nav Item - User Information -->
                    <li class="nav-item dropdown no-arrow">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span class="mr-2 d-none d-lg-inline text-gray-600 small" id="usernamebar"></span>
                            <img class="img-profile rounded-circle" id="userprofilepic">
                        </a>
                        <!-- Dropdown - User Information -->
                        <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in"
                            aria-labelledby="userDropdown">
                            <a class="dropdown-item" href="profile.html">
                                <i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i>
                                Profile
                            </a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="#" data-toggle="modal" data-target="#qrCodeModal"
                                onclick="qrcode_GE()">
                                <i class="fas fa-qrcode fa-sm fa-fw mr-2 text-gray-400"></i>
                                QR Code
                            </a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="#" data-toggle="modal" data-target="#logoutModal">
                                <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>
                                Logout
                            </a>
                        </div>
                    </li>
                </ul>
                <!-- End of Topbar -->
            </div>
        </div>
    </nav>

    <!-- Begin Page Content -->
    <section>
        <div class="container container-lg-fluid">
            <div class="card-main shadow mb-4">
                <div class="card-header py-3 d-flex bd-highlight align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary bd-highlight">Build Your Profile</h6>
                </div>
                <div class="card-body wizard-card">
                    <form id="LoginForm" action="post">
                        <div class="row">
                            <div class="col-12">
                                <h6 class="info-text text-center"> Let's start with the basic information (with
                                    validation)
                                </h6>
                            </div>
                            <div class="col-md-5 col-sm-12">
                                <div class="picture-container">
                                    <div class="profile-picture">
                                        <img src="images/avatar.gif" class="picture-src" id="PicturePreview" title="" />
                                        <input type="file" name="profilepic" class="form-control" id="profilepic">
                                    </div>
                                    <h6>Choose Picture <small>(required)</small></h6>
                                </div>
                            </div>
                            <div class="col-md-7 col-sm-12">
                                <div class="form-group">
                                    <label>Name <small>(required)</small></label>
                                    <input name="uname" id="uname" type="text" class="form-control"
                                        placeholder="Andrew..." required>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 col-12">
                                        <div class="form-group">
                                            <label>Email</label>
                                            <input name="email" id="email" type="text" class="form-control" readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-12">
                                        <div class="form-group">
                                            <label>Gender <small>(required)</small></label>
                                            <select name="Gender" id="gender" class="form-control" required>
                                                <option value="" disabled selected>Select your option</option>
                                                <option value="M"> Male </option>
                                                <option value="F"> Female </option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-12">
                                        <div class="form-group">
                                            <label>Birthday <small>(required)</small></label>
                                            <input type="date" id="dob" class="form-control" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-12">
                                        <div class="form-group">
                                            <label>Contact <small>(required)</small></label>
                                            <input type="tel" id="phone" pattern="[0-9]{3}-[0-9]{7,8}"
                                                class="form-control" placeholder="XXX-XXXXXXXX" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-12">
                                        <div class="form-group">
                                            <label>Faculty <small>(required)</small></label>
                                            <select name="Faculty" id="faculty" class="form-control" required>
                                                <option value="" disabled selected>Select your option</option>
                                                <option value="FICT"> FICT </option>
                                                <option value="FBF"> FBF </option>
                                                <option value="FSc"> FSc </option>
                                                <option value="FEGT"> FEGT </option>
                                                <option value="ICS"> ICS </option>
                                                <option value="FMHS"> FMHS </option>
                                                <option value="FAM"> FAM </option>
                                                <option value="LKCFES"> LKCFES </option>
                                                <option value="FCI"> FCI </option>
                                                <option value="CFSSL"> CFS-SL </option>
                                                <option value="CFSKPR"> CFS-KPR </option>
                                                <option value="CEE"> CEE </option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-12">
                                        <div class="form-group">
                                            <label>Intake <small>(required)</small></label>
                                            <div class="row">
                                                <div class="col-6">
                                                    <select name="IntakeYear" class="profile-year form-control"
                                                        id="intakeyear" required>
                                                        <option value="" disabled selected>-</option>
                                                    </select>
                                                </div>
                                                <div class="col-6">
                                                    <select name="IntakeSem" id="intakesem" class="form-control"
                                                        required>
                                                        <option value="" disabled selected>-</option>
                                                        <option value="Jan">Jan</option>
                                                        <option value="May">May</option>
                                                        <option value="Oct">Oct</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-12">
                                        <div class="form-group">
                                            <label>Graduated <small>(required)</small></label>
                                            <select name="GradStatus" id="gradstatus" class="form-control" required>
                                                <option value="" disabled selected>Select your option</option>
                                                <option value="Yes"> Yes </option>
                                                <option value="No"> No </option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-12">
                                        <div class="form-group" id="graddate">
                                            <label>Graduate Date <small>(required)</small></label>
                                            <div class="row">
                                                <div class="col-6">
                                                    <select name="GradYear" class="profile-year form-control"
                                                        id="graduateyear" required>
                                                        <option value="" disabled selected>-</option>
                                                    </select>
                                                </div>
                                                <div class="col-6">
                                                    <select name="GradMonth" id="graduatemonth" class="form-control">
                                                        <option value="" disabled selected>-</option>
                                                        <option value="March"> March </option>
                                                        <option value="October"> October</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-group">
                                    <label> Address <small>(required)</small></label>
                                    <textarea name="address" id="address" class="form-control" rows="3"
                                        placeholder="No 10...." required></textarea>
                                </div>
                            </div>
                            <div class="col-12">
                                <th><input type="submit" name="submit" value="Submit" id="submit"
                                        class="float-right btn btn-fill btn-primary btn-wd" /></th>
                            </div>
                        </div> <!-- end row -->
                    </form>
                </div>
            </div>
        </div>
    </section>
    <!-- /.container -->

    <!-- Footer -->
    <footer class="sticky-footer bg-white">
        <div class="container my-auto">
            <div class="copyright text-center my-auto">
                <span>Copyright &copy; UTAR 2SHARE. All Rights Reserved.</span>
            </div>
        </div>
    </footer>
    <!-- End of Footer -->

    <a class="scroll-to-top rounded" href="#page-top">
        <i class="fas fa-angle-up"></i>
    </a>

    <!-- Logout Modal-->
    <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" type="button" id="SignOut">Log Out</button>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Modal-->
    <div class="modal fade" id="qrCodeModal" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">My QR Code</h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body text-center">
                    <div id="QRcode_preview" class="container-fluid"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" type="button" data-dismiss="modal">Finish</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <!-- Js / Jquery -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.min.js"></script>

    <!-- Firebase login-->
    <script src="https://www.gstatic.com/firebasejs/7.0.0/firebase.js"></script>
    <script src="js/AccountFirebase.js"></script>

    <!-- jQuery Pull to Refresh plugin -->
    <script src='vendor/pulltorefresh/jquery.p2r.min.js' type='text/javascript' defer></script>

    <!-- QR Code Generator -->
    <script src="vendor/QRCode/jquery-qrcode.min.js"></script>

    <!-- Custome JS -->
    <script src="js/utar2share.js"></script>
    <script src="js/bootstrap-dialog.min.js"></script>
    <script src="js/qrcode.js"></script>

    <script>

        var dtToday = new Date();
        var end = 1900;
        var monthnow = dtToday.getMonth() + 1;
        var daynow = dtToday.getDate();
        var yearnow = dtToday.getFullYear();

        $(function () {//onload
            initApp().then(function (user) {
                GetUser(user);
            });

            for (var year = yearnow; year >= end; year--) {
                $('.profile-year').append("<option>" + year + "</option>");
            }

            // Prepare the preview for profile picture
            $("#profilepic").change(function () {
                readURL(this);
            });

            if (monthnow < 10)
                monthnow = '0' + monthnow.toString();
            if (daynow < 10)
                daynow = '0' + daynow.toString();
            var maxDate = yearnow + '-' + monthnow + '-' + daynow;
            var minDate = end + '-' + monthnow + '-' + daynow;
            $('#dob').attr('max', maxDate);
            $('#dob').attr('min', minDate);

            $("#graddate select").attr("disabled", "disabled");
            $("#gradstatus").on('change', function () {
                if ($(this).find(":selected").val() == "Yes") {
                    $("#graddate select").removeAttr("disabled");
                } else {
                    $("#graddate select").attr("disabled", "disabled");
                }
            });

            $("#LoginForm").submit(function (event) {
                event.preventDefault();
                var user = firebase.auth().currentUser;
                updateView(user);
            });
        });

        function getdata(user) {
            return new Promise((resolve, reject) => {
                var obj = new Object();
                obj.displayName = $("#uname").val();
                obj.gender = $("#gender").find(":selected").val();
                obj.dob = $("#dob").val();
                obj.phone = $("#phone").val();
                obj.faculty = $("#faculty").find(":selected").val();
                obj.intakeyear = $("#intakeyear").find(":selected").val();
                obj.intakesem = $("#intakesem").find(":selected").val();
                obj.gradstatus = $("#gradstatus").find(":selected").val();
                obj.graduateyear = obj.gradstatus == "Yes" ? $("#graduateyear").find(":selected").val() : "";
                obj.graduatemonth = obj.gradstatus == "Yes" ? $("#graduatemonth").find(":selected").val() : "";
                obj.address = $("#address").val();
                obj.updateDateTime = firebase.firestore.FieldValue.serverTimestamp();

                if ($("#profilepic")[0].files[0]) {
                    var storageRef = firebase.storage().ref().child('profile-image/' + user.uid);
                    var file = $("#profilepic")[0].files[0];
                    var metadata = {
                        'contentType': file.type
                    };
                    storageRef.delete().then(function () {
                        storageRef.put(file, metadata).then(function (snapshot) {
                            snapshot.ref.getDownloadURL().then(function (downloadURL) {
                                obj.photoURL = downloadURL;
                                resolve(obj);
                            });
                        });
                    });
                } else if (user.photoURL == null) {
                    obj.photoURL = "https://i.imgur.com/oW1dGDI.jpg";
                    resolve(obj);
                } else {
                    obj.photoURL = user.photoURL;
                    resolve(obj);
                }
            });
        }

        function updateView(user) {
            var docRef = firebase.firestore().collection("users");
            docRef.where("email", "==", user.email).get().then(function (querySnapshot) {
                querySnapshot.forEach(function (thisDoc) {
                    if (thisDoc.exists) {
                        getdata(user).then(function (obj) {
                            docRef.doc(thisDoc.id).update(obj);
                            user.updateProfile({
                                displayName: obj.displayName,
                                photoURL: obj.photoURL
                            });
                            $.dialog.alert('User Profile', "Updated");
                        });
                    }
                });
            }).catch(function (error) {
                console.log(error.message);
            });

        }

        function GetUser(user) {
            var username = "";
            if (user.displayName != null) {
                username = user.displayName;
            }

            var db = firebase.firestore();
            db.collection("users").where("email", "==", user.email).get().then(function (querySnapshot) {
                querySnapshot.forEach(function (doc) {
                    if (doc.exists) {
                        $("#uname").val(username);
                        $("#email").val(doc.data().email);
                        $("#gender").val(doc.data().gender);
                        $("#dob").val(doc.data().dob);
                        $("#phone").val(doc.data().phone);
                        $("#faculty").val(doc.data().faculty);
                        $("#intakeyear").val(doc.data().intakeyear);
                        $("#intakesem").val(doc.data().intakesem);
                        $("#gradstatus").val(doc.data().gradstatus);
                        if (doc.data().gradstatus && doc.data().gradstatus == "Yes") {
                            $("#graduateyear").removeAttr("disabled").val(doc.data().graduateyear);
                            $("#graduatemonth").removeAttr("disabled").val(doc.data().graduatemonth);

                        }
                        $("#address").val(doc.data().address);
                        $('#PicturePreview').attr('src', doc.data().photoURL).fadeIn('slow');
                    }
                });
            }).catch(function (error) {
                console.log("Error getting document:", error);
            });
        }

        function readURL(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    $('#PicturePreview').attr('src', e.target.result).fadeIn('slow');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

    </script>

</body>

</html>